const vehDetails = {
  UP66D9490: "Eicher",
  UP66D9492: "Eicher",
  UP66D9498: "Eicher",
  UP66D9502: "Eicher",
  UP65AT6683: "Eicher",
  UP65AT6684: "Eicher",
  UP65AT6686: "Eicher",
  UP65AT6687: "Eicher",
  UP65AT6689: "Eicher",
  UP65AT6690: "Eicher",
  UP65AT6691: "Eicher",
  UP65AT6692: "Eicher",
  UP65AT6693: "Eicher",
  UP65AT6694: "Eicher",
  UP65AT6695: "Eicher",
  UP65AT6696: "Eicher",
  UP65AT6697: "Eicher",
  UP65AT6698: "Eicher",
  UP65AT6699: "Eicher",
  UP65AT6700: "Eicher",
  UP65AT6701: "Eicher",
  UP65AT6702: "Eicher",
  UP65AT6703: "Eicher",
  UP65AT9014: "Eicher",
  UP65AT9015: "Eicher",
  UP65AT9016: "Eicher",
  UP65AT9017: "Eicher",
  UP65BT0846: "Eicher",
  UP65BT0847: "Eicher",
  UP65BT0848: "Eicher",
  UP65BT0849: "Eicher",
  UP65AT9947: "Eicher",
  UP65AT9948: "Eicher",
  UP65AT9949: "Eicher",
  UP65AT9131: "Eicher",
  UP65AT6995: "Eicher",
  UP65GT1223: "Ashokleyland",
  UP65GT1224: "Ashokleyland",
  UP65GT1225: "Ashokleyland",
  UP65GT1226: "Ashokleyland",
  UP65GT1419: "Ashokleyland",
  UP65GT2118: "TATA",
  UP65GT3973: "Ashokleyland",
  UP65GT3974: "Ashokleyland",
  UP65GT3975: "Ashokleyland",
  UP65GT3976: "Ashokleyland",
  UP65GT3977: "Ashokleyland",
  UP65GT3978: "Ashokleyland",
  UP65GT3979: "Ashokleyland",
  UP65GT3980: "Ashokleyland",
  UP65GT3981: "Ashokleyland",
  UP65GT3982: "Ashokleyland",
  UP70GT8996: "Ashokleyland",
  UP70GT8997: "Ashokleyland",
  UP63AT5428: "Ashokleyland",
  UP63AT5429: "Ashokleyland",
  UP63AT5430: "Ashokleyland",
  UP65JT0869: "Ashokleyland",
  UP65JT0870: "Ashokleyland",
  UP65JT0872: "Ashokleyland",
  UP65JT1078: "Ashokleyland",
  UP65JT1079: "Ashokleyland",
  UP65JT1080: "Ashokleyland",
  UP65JT1081: "Ashokleyland",
  UP65JT1207: "Ashokleyland",
  UP65JT1208: "Ashokleyland",
  UP65JT1209: "Ashokleyland",
  UP65JT4550: "Ashokleyland",
  UP65JT4551: "Ashokleyland",
  UP65JT4552: "Ashokleyland",
  UP64AT9703: "Ashokleyland",
  UP65HT1759: "Ashokleyland",
  UP65JT1164: "Ashokleyland",
  UP65JT1165: "Ashokleyland",
  UP65JT4678: "Ashokleyland",
  UP65JT4679: "Ashokleyland",
  UP65KT0364: "Ashokleyland",
  UP65KT0365: "Ashokleyland",
  UP65KT0502: "Ashokleyland",
  UP65KT0503: "Ashokleyland",
  UP65KT0507: "Ashokleyland",
  UP65KT0508: "Ashokleyland",
  UP65KT0509: "Ashokleyland",
  UP65KT0686: "Ashokleyland",
  UP65KT0687: "Ashokleyland",
  UP65KT0688: "Ashokleyland",
  UP65KT0689: "Ashokleyland",
  UP65KT0690: "Ashokleyland",
  UP65KT0691: "Ashokleyland",
  UP65KT0692: "Ashokleyland",
  UP65KT0693: "Ashokleyland",
  UP63BT1268: "Ashokleyland",
  UP63BT1269: "Ashokleyland",
  UP63BT1270: "Ashokleyland",
  UP63BT1271: "Ashokleyland",
  UP63BT1272: "Ashokleyland",
  UP63BT1274: "Ashokleyland",
  UP63BT1275: "Ashokleyland",
  UP63BT1276: "Ashokleyland",
  UP63BT1277: "Ashokleyland",
  UP63BT1278: "Ashokleyland",
  UP63BT1279: "Ashokleyland",
  UP63BT1280: "Ashokleyland",
  UP63BT1281: "Ashokleyland",
  UP63BT1282: "Ashokleyland",
  UP63BT1283: "Ashokleyland",
  UP63BT1345: "Ashokleyland",
  UP63BT1346: "Ashokleyland",
  UP63BT1347: "Ashokleyland",
  UP63BT1348: "Ashokleyland",
  UP63BT1349: "Ashokleyland",
  UP63BT1350: "Ashokleyland",
  UP63BT1351: "Ashokleyland",
  UP63BT1352: "Ashokleyland",
  UP63BT1353: "Ashokleyland",
  UP63BT1354: "Ashokleyland",
  UP63BT1355: "Ashokleyland",
  UP63BT1356: "Ashokleyland",
  UP63BT1357: "Ashokleyland",
  UP63BT1358: "Ashokleyland",
  UP63BT1463: "Ashokleyland",
  UP65LT4022: "Eicher CNG",
  UP65LT4023: "Eicher CNG",
  UP65LT4024: "Eicher CNG",
  UP65LT4025: "Eicher CNG",
  UP65LT9779: "TATA",
  UP65LT9780: "TATA",
  UP65LT9781: "TATA",
  UP65LT9782: "TATA",
  UP65LT9783: "TATA",
  UP65LT9784: "TATA",
  UP65LT9950: "TATA",
  UP65LT9952: "TATA",
  UP65LT9953: "TATA",
  UP65LT9957: "TATA",
  UP65LT9958: "TATA",
  UP65MT0160: "TATA",
  UP65MT0161: "TATA",
  UP65MT0162: "TATA",
  UP65MT0163: "TATA",
  UP65MT0328: "TATA",
  UP65MT0329: "TATA",
  UP65MT0330: "TATA",
  UP65MT0332: "TATA",
  UP65MT0334: "TATA",
  UP65MT0577: "TATA",
  UP65MT0578: "TATA",
  UP65MT0579: "TATA",
  UP65MT0580: "TATA",
  UP65MT0686: "TATA",
  UP65MT0687: "TATA",
  UP65MT0688: "TATA",
  UP65MT0689: "TATA",
  UP65MT0434: "TATA",
  UP65MT0435: "TATA",
  UP65MT1418: "TATA",
  UP65MT1419: "TATA",
  UP65MT1420: "TATA",
  UP65MT1421: "TATA",
  UP65MT1422: "TATA",
};

const rp = require("request-promise");
const TOKEN =
  "Bearer eyJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE2OTQ1ODUwMTAsInVzZXJJZCI6ImJvdHVzZXItLTZlNDAwYWYzLWE5MTItNGQ5ZS1iOTJhLTRjZjNmOTlhZDU0ZCIsIm1vYmlsZU51bWJlciI6ImJvdHVzZXItLTZlNDAwYWYzLWE5MTItNGQ5ZS1iOTJhLTRjZjNmOTlhZDU0ZCIsIm9yZ0lkIjoiNTE0MmEyNzUtMDc4Yi00MzYyLTkyMjMtY2ZhZTBlYzkwYzQ4IiwibmFtZSI6IlN5c3RlbSBJbnRlZ3JhdGlvbiIsIm9yZ1R5cGUiOiJGTEVFVF9PV05FUiIsImlzR29kIjpmYWxzZSwicG9ydGFsVHlwZSI6ImJhc2ljIn0.JBfunqi4-CMf3wrkCn_2L_8t9yleDLPXpOtsvJRzZlU";

async function getVehicles() {
  try {
    let url = `https://apis.fretron.com/shipment-view/partner-fleet/fleets/v2?size=200`;
    let res = await rp({
      uri: url,
      method: "GET",
      json: true,
      headers: {
        authorization: TOKEN,
      },
    });
    if (res.status != 200) {
      console.log(`vehicle Get Error ${e.message}`);
    }

    return res?.data?.length ? res.data : [];
  } catch (e) {
    console.log(`Catched Error While Getting Vehicles ${e.message}`);
  }
  return [];
}
async function getVAHANdetails(vehNo) {
  try {
    let url = `https://apis.fretron.com/partner-fleet/v2/vehicle/registration/details/v2?vehicleNumber=${vehNo}`;
    let res = await rp({
      uri: url,
      method: "GET",
      headers: {
        authorization: TOKEN,
      },
      json: true,
    });
    if (!res.status == 200) {
      console.log(`VAHAN Api Error ${e.message}`);
    }
    return res?.status == 200 ? res.data : null;
  } catch (e) {
    console.log(`Catched Error While Getting Vehicles ${e.message}`);
  }
  return null;
}

async function udpateVeh(payload) {
  try {
    let url = `https://apis.fretron.com/partner-fleet/v2/bulk/actions`;
    let res = await rp({
      uri: url,
      method: "PUT",
      body: payload,
      json: true,
      headers: {
        authorization: TOKEN,
      },
    });
    // console.log(res);
    if (res?.status == 200) {
      console.log(`Vehicle Updated Successfully`);
    }else{

        console.log(`vehicle update Error ${res?.error}`);
    }


    return res;
  } catch (e) {
    console.log(`Catched Error While Getting Vehicles ${e.message}`);
  }
  return null;
}

async function main() {
  try {
    let vehicles = await getVehicles();
    console.log(vehicles?.length);

    for (let veh of vehicles) {
      let vehNo = veh?.vehicle?.vehicleRegistrationNumber;
      let vehId = veh?.uuid;

      console.log(`Executing Vehicle ${vehNo}`);
      let vahanDetails = await getVAHANdetails(vehNo);
      if (!vahanDetails) {
        console.log(`Vahan Details not Found For ${vehNo}`);
        continue;
      }

      let vehManufacture = null;
      if (vehDetails[vehNo]) {
        vehManufacture = vehDetails[vehNo];
      }
      let engineNumber = vahanDetails?.engineNumber;
      let chassisNumber = vahanDetails?.chassisNumber;

      if (!engineNumber || !chassisNumber || !vehManufacture) {
        console.log(`Some Info Missing For ${vehNo}`);
        console.log(
          `engineNumber ${engineNumber} chassisNo ${chassisNumber} vehManufacture ${vehManufacture}`
        );
      }
      let engineData = {
        actionName: "cfs",
        payload: {
          cfs: [
            {
              fieldType: "text",
              fieldKey: "EngineNumber",
              value: engineNumber,
              indexedValue: [],
              valueType: "string",
              definitionId: null,
            },
          ],
        },
      };

      let vehUpdatePayload = {
        partnerUUID: vehId,
        actions: [
          {
            actionName: "chassisNumber",
            payload: {
              chassisNumber: chassisNumber,
            },
          },
          {
            actionName: "vehicleManufacturer",
            payload: {
              vehicleMake: vehManufacture,
            },
          },
          engineData,
        ],
      };

      console.log(JSON.stringify(vehUpdatePayload));

      await udpateVeh(vehUpdatePayload);
    //   break;
    }
  } catch (e) {
    console.log(`catched Error ${e.message}`);
  }
}

main();
